---
- hosts: all
  become: yes
  vars:
    release: 3.1.0
    cluster_name: cluster_test
    seeds: "192.168.1.131, 192.168.1.131, 192.168.1.133"
    NIC: eth1

  tasks:
  - name: Install add-apt-repository command utility on Debian
    package: name=software-properties-common state=present

  - name: install basic configuration
    apt:
      name: [
      'apt-transport-https'
      , 'wget'
      , 'gnupg2'
      , 'dirmngr'
      , 'gnupg'
      , 'htop'
      , 'collectd'
      ]
      state: present
    become: yes

  - name: add release key for scylla
    apt_key:
      url: https://download.opensuse.org/repositories/home:/scylladb:/scylla-3rdparty-stretch/Debian_9.0/Release.key
      state: present
    become: yes


  - name: add key for scylla
    apt_key:
      keyserver: keyserver.ubuntu.com
      id: 17723034C56D4B19
      state: present
    become: yes

  - name: Download Scylla {{ release }} repo for Debian 9 (Jessie)
    get_url: url=http://repositories.scylladb.com/scylla/repo/798d48b1-a435-4a84-b5d0-800b8b0682d0/debian/scylladb-3.1-stretch.list dest=/etc/apt/sources.list.d/scylla.list

  - name: update cache 
    become: yes
    apt: update_cache=yes


  - name: Install scylla {{ release }} on Debian / Ubuntu
    apt: name=scylla state=present allow_unauthenticated=yes force=yes

  - name: Configure Cluster name in yaml file
    shell: sed -i -- 's/Test Cluster/{{ cluster_name }}/g' /etc/scylla/scylla.yaml

  - name: Configure seeds in yaml file
    shell: sed -i -- '/seeds/s/127.0.0.1/{{ seeds }}/g' /etc/scylla/scylla.yaml

  - name: Configure listen address + rpc address in yaml file
    shell: sed -i -- "s/localhost/$(hostname -i)/g" /etc/scylla/scylla.yaml

  - name: Run Scylla Setup (RAID-0, XFS format, NIC queue, disk IOtune), this may take a while
    shell: scylla_setup --nic {{ NIC }} --setup-nic --no-raid-setup --developer-mode --no-io-setup

  - name: Reboot server/s (required by Scylla)
    become: yes
    shell: sleep 2 && shutdown -r now "Ansible reboot"
    async: 1
    poll: 0
    ignore_errors: true

  - name: Wait for server/s to come up from boot
    local_action: wait_for host={{ inventory_hostname }} state=started port=22 delay=30 timeout=300 connect_timeout=60
    become: false
  